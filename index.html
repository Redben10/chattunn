<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXTTunnel</title>
    <style>
        body { font-family: Arial, sans-serif; }
        button { margin: 5px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>TXTTunnel</h1>
    <button id="createTunnelButton">Create Tunnel</button>
    <button id="joinTunnelButton">Join Tunnel</button>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type your message here..." />
    <button id="sendMessageButton">Send Message</button>

    <script>
        let currentTunnelId = '';
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');

        document.getElementById('createTunnelButton').addEventListener('click', () => {
            const tunnelId = prompt("Enter tunnel ID to create:");
            if (tunnelId) {
                fetch('https://txttunnel.onrender.com/api/v2/tunnel/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: tunnelId })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to create tunnel');
                    return response.json();
                })
                .then(data => {
                    currentTunnelId = data.id;
                    startListening(currentTunnelId);
                })
                .catch(err => alert(err.message));
            }
        });

        document.getElementById('joinTunnelButton').addEventListener('click', () => {
            const tunnelId = prompt("Enter tunnel ID to join:");
            if (tunnelId) {
                startListening(tunnelId);
            }
        });

        function startListening(tunnelId) {
            fetch(`https://txttunnel.onrender.com/api/v2/tunnel/stream?id=${tunnelId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Failed to connect to tunnel');
                    const eventSource = new EventSource(`https://txttunnel.onrender.com/api/v2/tunnel/stream?id=${tunnelId}`);
                    eventSource.onmessage = event => {
                        messagesDiv.innerHTML += `<div>${event.data}</div>`;
                        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
                    };
                    currentTunnelId = tunnelId;
                })
                .catch(err => alert(err.message));
        }

        document.getElementById('sendMessageButton').addEventListener('click', () => {
            const message = messageInput.value;
            if (message && currentTunnelId) {
                fetch('https://txttunnel.onrender.com/api/v2/tunnel/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentTunnelId, content: message })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to send message');
                    messageInput.value = ''; // Clear input
                })
                .catch(err => alert(err.message));
            } else {
                alert('You must join a tunnel and enter a message to send.');
            }
        });
    </script>
</body>
</html>
