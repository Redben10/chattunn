<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXTTunnel Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        #chatContainer { max-width: 500px; margin: 0 auto; }
        #messages { border: 1px solid #ddd; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
        #inputContainer { display: flex; }
        #messageInput { flex: 1; padding: 10px; }
        #sendButton, #createButton, #joinButton, #setUsernameButton { padding: 10px; margin-left: 5px; cursor: pointer; }
        #sendButton:disabled { background-color: #ddd; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="chatContainer">
    <h2>TXTTunnel Chat</h2>
    <div id="roomInfo">Connected to room: <strong>global</strong></div>
    <div id="messages"></div>
    <div id="inputContainer">
        <input type="text" id="messageInput" placeholder="Type a message..." disabled>
        <button id="sendButton" disabled>Send</button>
    </div>
    <div style="margin-top: 10px;">
        <button id="createButton">Create Room</button>
        <button id="joinButton">Join Room</button>
        <button id="setUsernameButton">Set Username</button>
    </div>
</div>

<script>
    const serverUrl = "https://txttunnel.onrender.com";
    let currentRoom = "global";
    let username = "";
    const messagesDiv = document.getElementById("messages");
    const roomInfo = document.getElementById("roomInfo");
    const sendButton = document.getElementById("sendButton");
    const messageInput = document.getElementById("messageInput");

    joinRoom("global");

    document.getElementById("createButton").addEventListener("click", () => {
        const roomId = prompt("Enter room code to create:");
        if (roomId) {
            fetch(`${serverUrl}/api/v2/tunnel/checkRoomExists`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: roomId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    alert("This room is already created. Try joining it instead.");
                } else {
                    createRoom(roomId);
                }
            })
            .catch(console.error);
        }
    });

    document.getElementById("joinButton").addEventListener("click", () => {
        const roomId = prompt("Enter room code to join:");
        if (roomId) {
            joinRoom(roomId);
        }
    });

    document.getElementById("setUsernameButton").addEventListener("click", () => {
        const newUsername = prompt("Enter your username:");
        if (newUsername) {
            username = newUsername;
            alert(`Username set to: ${username}`);
            messageInput.disabled = false;  // Enable message input
            sendButton.disabled = false;     // Enable send button
        }
    });

    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });

    function createRoom(roomId) {
        fetch(`${serverUrl}/api/v2/tunnel/create`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: roomId })
        })
        .then(response => {
            if (!response.ok) {
                response.text().then(alert);
                return;
            }
            currentRoom = roomId;
            roomInfo.innerHTML = `Connected to room: <strong>${currentRoom}</strong>`;
            joinRoom(currentRoom);
        })
        .catch(console.error);
    }

    function joinRoom(roomId) {
        currentRoom = roomId;
        roomInfo.innerHTML = `Connected to room: <strong>${currentRoom}</strong>`;
        messagesDiv.innerHTML = "";

        const eventSource = new EventSource(`${serverUrl}/api/v2/tunnel/stream?id=${currentRoom}&subChannel=main`);
        eventSource.onmessage = (event) => {
            const message = document.createElement("div");
            message.textContent = event.data;
            messagesDiv.appendChild(message);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message === "") return;

        const formattedMessage = `${username}: ${message}`;

        fetch(`${serverUrl}/api/v2/tunnel/send`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: currentRoom, content: formattedMessage, subChannel: "main" })
        })
        .then(response => {
            if (response.ok) {
                messageInput.value = "";
            } else {
                response.text().then(alert);
            }
        })
        .catch(console.error);
    }
</script>
</body>
</html>
