<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXTTunnel</title>
</head>
<body>
    <h1>Welcome to TXTTunnel</h1>
    <button onclick="createOrJoinTunnel('global')">Join/Create Global Tunnel</button>
    <button onclick="promptTunnelID()">Join/Create Specific Tunnel</button>

    <input type="text" id="messageInput" placeholder="Type your message here">
    <button id="sendButton" onclick="sendMessage()" style="display:none;">Send</button>

    <div id="messages"></div>

    <script>
        let currentTunnelID = null;
        let eventSource = null;

        function promptTunnelID() {
            const tunnelID = prompt("Enter tunnel ID:");
            if (tunnelID) {
                createOrJoinTunnel(tunnelID);
            }
        }

        async function createOrJoinTunnel(tunnelID) {
            const response = await fetch('https://txttunnel.onrender.com/api/v2/tunnel/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: tunnelID })
            });

            if (!response.ok) {
                if (response.status === 409) {
                    // Tunnel already exists, try to join it
                    alert(`Tunnel ${tunnelID} already exists. Joining...`);
                } else {
                    alert("Failed to create tunnel.");
                    return;
                }
            }

            // Always set the current tunnel ID
            currentTunnelID = tunnelID;

            // Start streaming messages
            if (eventSource) {
                eventSource.close(); // Close previous connection if any
            }
            eventSource = new EventSource(`https://txttunnel.onrender.com/api/v2/tunnel/stream?id=${currentTunnelID}`);

            eventSource.onmessage = function(event) {
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML += `<p>${event.data}</p>`;
            };

            document.getElementById("sendButton").style.display = "inline";
            document.getElementById("messageInput").focus();
        }

        async function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;

            if (!message) {
                alert("Please enter a message.");
                return;
            }

            const response = await fetch('https://txttunnel.onrender.com/api/v2/tunnel/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: currentTunnelID,
                    content: message
                })
            });

            if (response.ok) {
                messageInput.value = ""; // Clear the input after sending
            } else {
                alert("Failed to send message.");
            }
        }
    </script>
</body>
</html>
