<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXTTunnel Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        #chatContainer { max-width: 500px; margin: 0 auto; }
        #messages { border: 1px solid #ddd; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
        #inputContainer { display: flex; }
        #messageInput { flex: 1; padding: 10px; }
        #sendButton, #createButton, #joinButton { padding: 10px; margin-left: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="chatContainer">
    <h2>TXTTunnel Chat</h2>
    <div id="roomInfo">Connected to room: <strong>global</strong></div>
    <div id="messages"></div>
    <div id="inputContainer">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendButton">Send</button>
    </div>
    <div style="margin-top: 10px;">
        <button id="createButton">Create Room</button>
        <button id="joinButton">Join Room</button>
    </div>
</div>

<script>
    const serverUrl = "https://txttunnel.onrender.com";
    let currentRoom = "global";
    const messagesDiv = document.getElementById("messages");
    const roomInfo = document.getElementById("roomInfo");

    // Join the global room on page load
    joinRoom("global");

    // Create button logic
    document.getElementById("createButton").onclick = async () => {
        const roomId = prompt("Enter a room code to create:");
        if (roomId) {
            const exists = await checkRoomExists(roomId);
            if (exists) {
                alert(`Room "${roomId}" already exists. Please choose a different code.`);
            } else {
                await createRoom(roomId);
            }
        }
    };

    // Join button logic
    document.getElementById("joinButton").onclick = () => {
        const roomId = prompt("Enter a room code to join:");
        if (roomId) {
            joinRoom(roomId);
        }
    };

    // Send button logic
    document.getElementById("sendButton").onclick = sendMessage;

    // Send message on Enter key press
    document.getElementById("messageInput").addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
            event.preventDefault();  // Prevents newline in input
            sendMessage();
        }
    });

    async function checkRoomExists(roomId) {
        try {
            const response = await fetch(`${serverUrl}/api/v2/tunnel/stream?id=${roomId}&subChannel=chat`, {
                method: "GET",
            });

            // If the response is OK, it means the room exists
            return response.ok;
        } catch (error) {
            console.error("Error checking room:", error);
            return false;
        }
    }

    async function createRoom(roomId) {
        try {
            const response = await fetch(`${serverUrl}/api/v2/tunnel/create`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: roomId })
            });

            if (!response.ok) {
                throw new Error("Failed to create room.");
            }
            
            // Join the room after successful creation
            joinRoom(roomId);
        } catch (error) {
            alert("Error creating room.");
            console.error(error);
        }
    }

    function joinRoom(roomId) {
        currentRoom = roomId;
        roomInfo.innerHTML = `Connected to room: <strong>${roomId}</strong>`;
        messagesDiv.innerHTML = "";

        if (window.eventSource) {
            window.eventSource.close();
        }

        window.eventSource = new EventSource(`${serverUrl}/api/v2/tunnel/stream?id=${roomId}&subChannel=chat`);
        window.eventSource.onmessage = event => {
            const message = document.createElement("div");
            message.textContent = event.data;
            messagesDiv.appendChild(message);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };
    }

    function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const messageContent = messageInput.value.trim();
        if (messageContent === "") return;

        fetch(`${serverUrl}/api/v2/tunnel/send`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: currentRoom, content: messageContent, subChannel: "chat" })
        }).then(() => {
            messageInput.value = ""; // Clear the input field after sending
        }).catch(error => {
            alert("Failed to send message.");
            console.error(error);
        });
    }
</script>

</body>
</html>
